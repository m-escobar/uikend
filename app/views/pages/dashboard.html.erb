<div class="container">

  <% if @current_user.bookings.empty? then %>
    <div class="text-center shadow mt-5 p-5 bg-light rounded">
         <h2 class="dark-gray"> Você ainda não tem viagens reservadas! <h2>
        <%= link_to "Escolha o seu pacote", root_path, class: "ml-2 btn-banner-orange" %>
    </div>

  <% else %>
    <div class="shadow mt-5 p-5 bg-light rounded">
      <h2 class="text-center mb-2">Minhas viagens confirmadas</h2>
      <!-- Aplicação do GROUP_BY ID para agrupar os pacotes para os quais o usuário efetuou várias reservas -->
      <% groups_by_id = @my_booked_trips.group_by{|x| x.trip_id}.values %>
      <!-- Bookings_count será um array de hashes, cada hash será de um pacote contendo o id e a quantidade de reservas feitas pelo usuário para esse mesmo pacote -->
      <% bookings_count = [] %>
      <% groups_by_id.each do |trip| %>
        <% bc = {} %>
        <% bc[:id] = trip[0].trip_id %>
        <% bc[:count] = trip.count %>
        <% bookings_count << bc %>
      <% end %>

      <% trips_grouped = groups_by_id.map do |booked_trip_group| %>
        <% Trip.find(booked_trip_group[0].trip_id) %>
      <% end %>
      <% trips_ordered = trips_grouped.sort_by(&:trip_start) %>
      <% trips_ordered.each do |booked_trip| %>
           <div class="card-trip m-3">
            <% if booked_trip.photo? then %>
              <div class="banner_img" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url('<%= cl_image_path booked_trip.photo, height: 400, crop: :fit %>')">
              </div>
            <% else %>
              <div class="banner_img" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url('<%= cl_image_path 'trip_square', height: 400, crop: :fit %>')">
              </div>
            <% end %>

            <div class="card-trip-infos p-2">
              <div class="card-top-details mb-2">
                <div id="aligned-name-info">
                  <div>
                    <h2 class="pr-2"><%= link_to booked_trip.name, booked_trip ,class: "text-decoration-none color-dark-gray"%>
                    <%= link_to booked_trip do %>
                      <i class="fas fa-info-circle"></i>
                    <% end %></h2>
                  </div>
                  <% b_count = bookings_count.select{ |item| item[:id] == booked_trip.id }[0][:count] %>
                  <h5>Vagas reservadas: <%= b_count %></h5>
                </div>
                <h4><%= booked_trip.description %></h4>
              </div>
              <div class="card-bottom-details">
                <div>
                  <h5><%= booked_trip.place %></h5>
                  <p>Ida: <%= booked_trip.trip_start.strftime("%d/%m/%Y") %> | Volta: <%= booked_trip.trip_end.strftime("%d/%m/%Y") %></p>
                </div>
                <div class="text-right">
                  <h5 class="card-trip-pricing mb-2">R$ <%= booked_trip.price %>/pessoa | Total: R$ <%= booked_trip.price * b_count %></h5>
                  <%= link_to "Reserve mais uma vaga", new_trip_booking_path(booked_trip), class: "ml-2 px-4 btn-banner-orange" %>
                </div>
              </div>
            </div>
          </div>
      <% end %>
    </div>
  <% end %>

  <% if @current_user.trips.empty? then %>
    <div class="text-center shadow mt-5 p-5 bg-light rounded">
      <h2>Você ainda não tem viagens publicadas! </h2>
      <%= link_to "Publique o seu pacote", new_trip_path, class: "ml-2 btn-banner-green" %>
    </div>
  <% else %>
    <div class="shadow mt-5 p-5 bg-light rounded">
      <h2 class="text-center mb-2">Pacotes oferecidos</h2>
      <% @my_offered_trips.sort_by(&:trip_start).each do |offered_trip| %>
           <div class="card-trip m-3">
            <% if offered_trip.photo? then %>
              <div class="banner_img" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url('<%= cl_image_path offered_trip.photo, height: 400, crop: :fit %>')">
              </div>
            <% else %>
              <div class="banner_img" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url('<%= cl_image_path 'trip_square', height: 400, crop: :fit %>')">
              </div>
            <% end %>

            <div class="card-trip-infos p-2">
              <div class="card-top-details mb-2">
                <div id="aligned-name-info">
                  <h2 class="pr-2"><%= link_to offered_trip.name, offered_trip ,class: "text-decoration-none color-dark-gray"%>
                  <% if offered_trip.bookings.count == 0 %>
                    <%= link_to edit_trip_path(offered_trip) do %>
                    <i class="fas fa-edit"></i>
                    <% end %>
                  <% end %></h2>
                  <div>
                    <h5>Vagas reservadas: <%= offered_trip.bookings.count%></h5>
                    <h5>Vagas disponíveis: <%= offered_trip.capacity - offered_trip.bookings.count%></h5>
                  </div>
                </div>
                <h4><%= offered_trip.description %></h4>
              </div>
              <div class="card-bottom-details">
                <div>
                  <h5><%= offered_trip.place %></h5>
                  <p>Ida: <%= offered_trip.trip_start.strftime("%d/%m/%Y") %> | Volta: <%= offered_trip.trip_end.strftime("%d/%m/%Y") %></p>
                </div>
                <div class="text-right">
                  <h5 class="card-trip-pricing mb-2">R$ <%= offered_trip.price %>/pessoa | Total: R$ <%= offered_trip.price * offered_trip.bookings.count%></h5>
                  <%= link_to "Detalhes e viajantes confirmados", offered_trip, class: "ml-2 btn-banner-green" %>
                </div>
              </div>
            </div>
          </div>
      <% end %>
    </div>
  <% end %>

</div>
